= XS2ASandbox

This is description of services,dependencies and steps  to run XS2ASandbox on any linux system.

.Table of services and dependencies:

[%autowidth.stretch]
|===
|Service |Dependencies |Environment variables |Ports

|xs2a-connector-examples |Java 8 |
SPRING_PROFILES_ACTIVE +
ASPSP-PROFILE_BASEURL +
CMS_URL +
LEDGERS_URL +
CONSENT_SERVICE_BASEURL +
SPRING_PROFILES_ACTIVE +
skip_ssl_certificate_verification +
DB_PASSWORD +
DB_USER +
DB_DATABASE +
DB_HOST +
| 8089,8189
|xs2a-asps--profile |Java 8 |
SPRING_PROFILES_ACTIVE +
BANK_PROFILE_PATH +
| 48080
|xs2a-consent-management |Java 8 |
ASPSP-PROFILE_BASEURL +
SPRING_DATASOURCE_URL +
SPRING_DATASOURCE_USERNAME +
SPRING_DATASOURCE_PASSWORD +
SERVER_KEY +
SPRING_LIQUIBASE_ENABLED +
SPRING_LIQUIBASE_URL +
SPRING_LIQUIBASE_DEFAULT_SCHEMA +
SPRING_LIQUIBASE_USER +
SPRING_LIQUIBASE_PASSWORD +
USED-NON-RECURRING-CONSENT-EXPIRATION.CRON.EXPRESSION +
SPRING_JPA_PROPERTIES_HIBERNATE_DEFAULT_SCHEMA +
skip_ssl_certificate_verification +
| 38080
| xs2a-consent-management-db | Postgresql 9.5 |
POSTGRESQL_ADMIN_PASSWORD +
POSTGRESQL_DATABASE +
POSTGRESQL_USER +
POSTGRESQL_PASSWORD | 5432
|xs2a-online-banking | NGINX 1.15.5 |
XS2A_URL +
LEDGERS_URL +
CMS_URL +
ONLINE_BANKING_SCA_LOGINPAGE +
ONLINE_BANKING_SCA_UIREDIRECT +
MANAGEMENT_ENDPOINTS_WEB_CORS_ALLOWED_METHODS +
MANAGEMENT_ENDPOINTS_WEB_CORS_ALLOWED_ORIGINS +
| 8090,8190
|ledgers | Java 8 |
SPRING_PROFILES_ACTIVE +
SPRING_JPA_SHOW_SQL +
DB_HOST +
DB_URL +
DB_DATABASE +
DB_USER +
DB_PASSWORD +
LIQUIBASE_ENABLED +
SCA_MULTILEVEL_ENABLED +
SPRING_MAIL_HOST +
SPRING_MAIL_PORT +
SPRING_MAIL_PROPERTIES_MAIL_FROM +
SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH +
SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE
| 8088,8188
|xs2a-online-banking-ui |NGINX 1.15.5 |
ONLINE_BANKING_SERVER_URL +
DEV_PORTAL_URL_EXT +
| 4400
|xs2a-tpp-ui | NGINX 1.15.5 |
LEDGERS_URL +
TPP_REST_SERVER_URL +
CERT_GEN_URL
| 4205
| xs2a-tpp-rest-server |Java 8 |
LEDGERS_URL +
SPRING_DATASOURCE_URL +
SPRING_DATASOURCE_USERNAME +
SPRING_DATASOURCE_PASSWORD +
SERVER_KEY +
USED-NON-RECURRING-CONSENT-EXPIRATION.CRON.EXPRESSION +
NOT-CONFIRMED-CONSENT-EXPIRATION.CRON.EXPRESSION +
NOT-CONFIRMED-PAYMENT-EXPIRATION.CRON.EXPRESSION +
CONSENT.CRON.EXPRESSION +
STOPLIST.CRON.EXPRESSION +
ENCRYPTION.CRON.EXPRESSION +
IBAN_GENERATOR_BANKCODE_NISP +
IBAN_GENERATOR_BANKCODE_RANDOM +
IBAN_GENERATOR_COUNTRYCODE +
| 8093
|developer-portal-ui | NGINX 1.15.5 |
XS2A_URL | 4206
|ledgers-db |  Postgresql 9.5  |
POSTGRESQL_ADMIN_PASSWORD +
POSTGRESQL_DATABASE +
POSTGRESQL_USER +
POSTGRESQL_PASSWORD
|  5432
|certificate-generator |Java 8 |
| 8092
| smtp server | any mail server to accept and send smtp messages | |
|===


== 1. Prerequisites

The applications need the prerequisites described below. You need to install prerequisites via your linux distributions package manager.
Select your linux distribution in the provided manual links.

=== 1.1 PostgreSQL

Manual to install PostgreSQL on linux server:
https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-centos-7

=== 1.2 Java 8

Manual to install Java 8 on linux server:
https://www.digitalocean.com/community/tutorials/how-to-install-java-on-centos-and-fedora

=== 1.3 NGINX

Manual to install NGINX on linux server:
https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-centos-7

=== 1.4 Mail Server

Additionally you need a working mail server.
This manual will not cover its installation.

== 2. Configuration

=== 2.1 PostgreSQL Databases

The application needs two databases. One for consent-management-system and one for ledgers.

Therefore we need to create these databases and two corresponding users.

```sh
$ sudo -u postgres psql
```

==== 2.1.1 Create and configure ledgers-db:

* create database:
```sh
$ postgres=# CREATE DATABASE ledgers;
```

* create user and password:
```sh
$ postgres=# CREATE USER ledgersdb WITH ENCRYPTED PASSWORD 'password-to-change';
```

* grant accesses:
```sh
$ postgres=# GRANT ALL PRIVILEGES ON DATABASE ledgers TO ledgersdb;
```

==== 2.1.2 Create and configure xs2a-consent-management-system-db:

* create database:
```sh
$ postgres=# CREATE DATABASE cms;
```

* create user and password:
```sh
$ postgres=# CREATE USER cmsdb WITH ENCRYPTED PASSWORD 'password-to-change';
```

* grant accesses:
```sh
$ postgres=# GRANT ALL PRIVILEGES ON DATABASE cms TO cmsdb;
```

* create cms schema:
```sh
$ postgres=# CREATE SCHEMA consent AUTHORIZATION cmsdb;
```

=== 2.2 Java Backend
==== 2.2.1 Java applications

* create directory for application binaries

```sh
$ mkdir /opt/sandbox
```

* copy the binaries:

```sh
$ cp *.jar /opt/sandbox/
```

* make the binaries executable:

```sh
$ chmod +x /opt/sandbox/*.jar
```

* run the binaries (through a startup script on server boot):

```sh
$ $JAVA_HOME/bin/java $JAVA_OPTS_ASPSP_PROFILE -jar /opt/sandbox/aspsp-profile.jar
$ $JAVA_HOME/bin/java $JAVA_OPTS_CMS -jar /opt/sandbox/consent-management.jar
$ $JAVA_HOME/bin/java $JAVA_OPTS_GATEWAY -jar /opt/sandbox/gateway-app.jar
$ $JAVA_HOME/bin/java $JAVA_OPTS_LEDGERS -jar /opt/sandbox/ledgers-app.jar
$ $JAVA_HOME/bin/java $JAVA_OPTS_OBA -jar /opt/sandbox/xs2a-online-banking.jar
$ $JAVA_HOME/bin/java $JAVA_OPTS_TPP -jar /opt/sandbox/tpp-rest-server.jar
$ $JAVA_HOME/bin/java -jar /opt/sandbox/certificate-generator.jar
```
NOTE: Please, note, that you have to change $JAVA_OPTS_* placeholder to the options you want to specify for every jar.
The table of options and possible configurations you can find below:


[%autowidth.stretch]
|===
| Placeholder | Service | Option | Possible configurations | Additional information
| $JAVA_OPTS_ASPSP_PROFILE | Aspsp-profile | SPRING.PROFILES.ACTIVE | debug_mode | debug_mode option allows you to change Aspsp-profile options via REST API. Should be used only for testing and not in production.
| | | BANK.PROFILE.PATH | /data/bank_profile.yml (example) | Mandatory path to your profile settings in .yml file
| $JAVA_OPTS_CMS | Consent management system | ASPSP-PROFILE.BASEURL | http://demo-dynamicsandbox-aspspprofile:8080/api/v1 (example) | Mandatory URL to your Aspsp-profile application.
| | | SPRING.DATASOURCE.URL | jdbc:postgresql://localhost/cms | URL to consent-management-database
| | | SPRING.DATASOURCE.USERNAME | cmsdb | The name of the user you created when creating consent-management-system-database
| | | SPRING.DATASOURCE.PASSWORD | password-to-change |
| | | SERVER.KEY | secret-to-change |
| | | SPRING.LIQUIBASE.ENABLED | true |
| | | SPRING.LIQUIBASE.URL | jdbc:postgresql://localhost/cms?currentSchema=consent |
| | | SPRING.LIQUIBASE.DEFAULT.SCHEMA | consent | Schema created for consent-management-database
| | | SPRING.LIQUIBASE.USER | cmsdb | The same as for SPRING.DATASOURCE.USERNAME
| | | SPRING.LIQUIBASE.PASSWORD | password-to-change | The same as for SPRING.DATASOURCE.PASSWORD
| | | USED-NON-RECURRING-CONSENT-EXPIRATION.CRON.EXPRESSION | 0 0 * * * * |
| | | SPRING.JPA.PROPERTIES.HIBERNATE.DEFAULT.SCHEMA | consent |
| | | skip.ssl.certificate.verification | true, false | Value used in XS2A-Sandbox is true
| $JAVA_OPTS_GATEWAY | XS2A-Connector-examples | SPRING.PROFILES.ACTIVE | postgres,mock-qwac | Mock-qwac is used only for testing, this profile mockes TPP QWAC certificate for every request. This profile should not be used for production
| | | ASPSP-PROFILE.BASEURL | http://localhost:8080/api/v1 (example) | Mandatory URL to your Aspsp-profile application.
| | | CMS.URL | http://localhost:8080 (example) | Mandatory consent-management-system URL
| | | LEDGERS.URL | http://localhost:8088 (example)| Mandatory Ledgers URL
| | | CONSENT.SERVICE.BASEURL | http://localhost:8080/api/v1 (example) | Base consent-management URL for calls to endpoints (CMS.URL + "api/v1")
| | | skip.ssl.certificate.verification | true, false | Value used in XS2A-Sandbox is true
| | | DB.PASSWORD | password-to-change |
| | | DB.USER | cmsdb |
| | | DB.DATABASE | cms |
| | | DB.HOST | localhost |
| $JAVA_OPTS_LEDGERS | Ledgers | SPRING.PROFILES.ACTIVE | postgres,sandbox |
| | | DB.HOST | localhost |
| | | DB.DATABASE |ledgers |
| | | DB.USER | ledgersdb |
| | | DB.PASSWORD | password-to-change |
| | | SCA.MULTILEVEL.ENABLED | false, true | Enables or disables Multilevel SCA functionality in Ledgers.
| | | APPLICATION_SECURITY_ENCRYPTIONALGORITHM | PBEWITHSHA1ANDDESEDE | Given configuration should be used.
| | | APPLICATION_SECURITY_MASTERPASSWORD | secret2-to-change |
| | | spring.mail.host | smtp.gmail.com (example) | SMTP Server configurations. Should be configured in accordance with existing SMTP server.
| | | spring.mail.port | 587 |
| | | spring.mail.username | username |
| | | spring.mail.password | password |
| | | spring.mail.properties.mail.smtp.starttls.enable | true |
| | | spring.mail.properties.mail.smtp.starttls.required | true |
| | | spring.mail.properties.mail.smtp.auth | true |
| | | spring.mail.properties.mail.smtp.connectiontimeout | 5000 |
| | | spring.mail.properties.mail.smtp.timeout | 5000 |
| | | spring.mail.properties.mail.smtp.writetimeout | 5000 |
| $JAVA_OPTS_OBA | Online banking | XS2A.URL | http://localhost:8089 | Mandatory URL to XS2A
| | | LEDGERS.URL | http://localhost:8088 |
| | | CMS.URL | http://localhost:8080 |
| | | ONLINE.BANKING.SCA.LOGINPAGE | https://demo-dynamicsandbox-onlinebankingui.cloud.adorsys.de/ (example) | Online-banking page, to which user would be redirected in Redirect approach
| | | ONLINE.BANKING.SCA.UIREDIRECT | true, false | XS2A Sandbox uses "true" as a value in this configuration
| | | MANAGEMENT.ENDPOINTS.WEB.CORS.ALLOWED.METHODS | GET,POST,PUT,DELETE,OPTIONS,PATCH | CORS settings
| | | MANAGEMENT.ENDPOINTS.WEB.CORS.ALLOWED.ORIGINS | https://demo-dynamicsandbox-onlinebankingui.cloud.adorsys.de | CORS settings
| $JAVA_OPTS_TPP | TPP REST server | LEDGERS.URL | http://localhost:8088 |
| | | SPRING.DATASOURCE.URL | jdbc:postgresql://localhost/cms |
| | | SPRING.DATASOURCE.USERNAME | cmsdb |
| | | SPRING.DATASOURCE.PASSWORD | password-to-change |
| | | SERVER.KEY | secret-to-change |
| | | USED-NON-RECURRING-CONSENT-EXPIRATION.CRON.EXPRESSION | 0 0 * * * * | Cron settings for consent-management-system
| | | NOT-CONFIRMED-CONSENT-EXPIRATION.CRON.EXPRESSION | 0 0 * * * * | Cron settings for consent-management-system
| | | NOT-CONFIRMED-PAYMENT-EXPIRATION.CRON.EXPRESSION | 0 0 * * * * | Cron settings for consent-management-system
| | | CONSENT.CRON.EXPRESSION | 0 0 * * * * | Cron settings for consent-management-system
| | | STOPLIST.CRON.EXPRESSION | 0 0 * * * * | Cron settings for consent-management-system
| | | ENCRYPTION.CRON.EXPRESSION | 0 0 * * * * | Cron settings for consent-management-system
| | | IBAN.GENERATOR.BANKCODE.NISP | 76070025 |
| | | IBAN.GENERATOR.BANKCODE.RANDOM | 90000001 |
| | | IBAN.GENERATOR.COUNTRYCODE | AU | Could be changed to any country code to generate ibans with desired country code
|===


NOTE: All possible mail configurations for Spring could be found here: https://www.quickprogrammingtips.com/spring-boot/how-to-send-email-from-spring-boot-applications.html

=== 2.3 Nginx Frontends

* tpp-ui:

```sh
$ cp tpp-ui-nginx.conf /etc/nginx/conf.d/
$ mkdir /usr/share/nginx/html/tpp-ui/
$ cp dist/tpp-ui/* /usr/share/nginx/html/tpp-ui/
```

* developerportal-ui:

```sh
$ cp developerportal-ui-nginx.conf /etc/nginx/conf.d/
$ mkdir /usr/share/nginx/html/developerportal-ui/
$ cp dist/developerportal-ui/* /usr/share/nginx/html/developerportal-ui/
```

* onlinebanking-ui:

```sh
$ cp onlinebanking-ui-nginx.conf /etc/nginx/conf.d/
$ mkdir /usr/share/nginx/html/onlinebanking-ui/
$ cp dist/onlinebanking-ui/* /usr/share/nginx/html/onlinebanking-ui/
```
