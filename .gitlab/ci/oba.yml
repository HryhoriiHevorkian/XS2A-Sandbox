####################
# Code Compilation #
####################

# Backend #

### How to separate block?

# Backends Java8:
#   stage: "Code Compilation"
#   <<: *build_java
#   variables:
#     BUILD_JAVA_VERSION: system@1.8
#   artifacts:
#     paths:
#       - "certificate-generator/target/certificate-generator.jar"
#     name: "$CI_PROJECT_NAME-${CI_BUILD_REF_NAME#*v}"
#     expire_in: "1 day"

# Backends Java11:
#   stage: "Code Compilation"
#   <<: *build_java
#   variables:
#     BUILD_JAVA_VERSION: system@1.11
#     JAVA_TOOL_OPTIONS: "-Djavax.net.ssl.trustStorePassword=changeit -XX:MaxRAM=3G"
# Frontend #

oba-ui:
 stage: "Code Compilation"
 script:
    - cd oba-ui
    - npm install
    - npm run build --prod
 cache:
    key: "OBA_UI_${CI_COMMIT_REF_SLUG}"
    paths:
     - oba-ui/node_modules
 artifacts:
    paths:
     - "oba-ui/dist"
    name: "$CI_PROJECT_NAME-${CI_BUILD_REF_NAME#*v}"
    expire_in: "1 day"

################
# Unit Testing #
################

# Frontend #

oba-ui:
  stage: "Unit Testing"
  script:
  - cd oba-ui
  - nvm use 10
  - npm ci
  - npm run test-ci

##################
# Docker Testing #
##################

# Backend #

oba:
  stage: "Docker Testing"
  variables:
    DOCKER_DIR: ${DOCKER_DIR_ONLINE_BANKING}
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING}
  <<: *build_dockerimage

  # Frontend #

oba-ui:
  stage: "Docker Testing"
  variables:
    DOCKER_DIR: ${DOCKER_DIR_ONLINE_BANKING_UI}
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING_UI}
  <<: *build_dockerimage

#####################
# Docker Publishing #
#####################

# Backends #

oba develop:
  stage: "Docker Publishing"
  only:
    - develop
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING}
    DOCKER_TAG: develop
  <<: *publish_dockerhub

oba nightly:
  stage: "Docker Publishing"
  only:
    - schedules
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING}
    DOCKER_TAG: nightly
  <<: *publish_dockerhub

oba master:
  stage: "Docker Publishing"
  only:
    - master
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING}
    DOCKER_TAG: latest
  <<: *publish_dockerhub

# Frondends #

oba-ui develop:
  stage: "Docker Publishing"
  only:
    - develop
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING_UI}
    DOCKER_TAG: develop
  <<: *publish_dockerhub

oba-ui nightly:
  stage: "Docker Publishing"
  only:
    - schedules
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING_UI}
    DOCKER_TAG: nightly
  <<: *publish_dockerhub

oba-ui master:
  stage: "Docker Publishing"
  only:
    - master
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING_UI}
    DOCKER_TAG: latest
  <<: *publish_dockerhub

########################
# OpenShift Deployment #
########################

# Backends #

oba develop:
  stage: "OpenShift Deployment"
  only:
    - develop
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING}
    DOCKER_TAG: develop # Dockerhub source tag
    OPENSHIFT_NAMESPACE: ${OPENSHIFT_NAMESPACE_DEV} # Openshift target namespace
  <<: *deploy_openshift

oba nightly:
  stage: "OpenShift Deployment"
  only:
    - schedules
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING}
    DOCKER_TAG: nightly # Dockerhub source tag
    OPENSHIFT_NAMESPACE: ${OPENSHIFT_NAMESPACE_INTEG} # Openshift target namespace
  <<: *deploy_openshift

oba demo:
  stage: "OpenShift Deployment"
  only:
    - master
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING}
    DOCKER_TAG: latest # Dockerhub source tag
    OPENSHIFT_NAMESPACE: ${OPENSHIFT_NAMESPACE_DEMO} # Openshift target namespace
  <<: *deploy_openshift

# Forntends #

oba-ui develop:
  stage: "OpenShift Deployment"
  only:
    - develop
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING_UI}
    DOCKER_TAG: develop # Dockerhub source tag
    OPENSHIFT_NAMESPACE: ${OPENSHIFT_NAMESPACE_DEV} # Openshift target namespace
  <<: *deploy_openshift

oba-ui nightly:
  stage: "OpenShift Deployment"
  only:
    - schedules
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING_UI}
    DOCKER_TAG: nightly # Dockerhub source tag
    OPENSHIFT_NAMESPACE: ${OPENSHIFT_NAMESPACE_INTEG} # Openshift target namespace
  <<: *deploy_openshift

oba-ui demo:
  stage: "OpenShift Deployment"
  only:
    - master
  variables:
    DOCKER_IMAGE: ${DOCKER_IMAGE_ONLINE_BANKING_UI}
    DOCKER_TAG: latest # Dockerhub source tag
    OPENSHIFT_NAMESPACE: ${OPENSHIFT_NAMESPACE_DEMO} # Openshift target namespace
  <<: *deploy_openshift

