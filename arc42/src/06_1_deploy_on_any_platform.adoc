# XS2ASandbox

Linux:

This is description of services,dependencies and steps  to run XS2ASandbox on any operation system.

.Table of services and dependencies:

[%autowidth.stretch]

|===
|Service |Dependencies |Environment variables |Ports 

|xs2a-connector-examples |Java 8 | TZ + 
SPRING_PROFILES_ACTIVE +
ASPSP-PROFILE_BASEURL + 
CMS_URL +
LEDGERS_URL +
CONSENT_SERVICE_BASEURL +
SPRING_PROFILES_ACTIVE +
skip_ssl_certificate_verification +
DB_PASSWORD +
DB_USER +
DB_DATABASE +
DB_HOST +
JAVA_OPTS | 8089,8189 
|xs2a-asps--profile |Java 8 | TZ +
SPRING_PROFILES_ACTIVE +  
BANK_PROFILE_PATH +
JAVA_OPTS 
| 48080           
|xs2a-consent-management |Java 8 |TZ + 
ASPSP-PROFILE_BASEURL +
SPRING_DATASOURCE_URL +
SPRING_DATASOURCE_USERNAME +
SPRING_DATASOURCE_PASSWORD +
SERVER_KEY +
SPRING_LIQUIBASE_ENABLED +
SPRING_LIQUIBASE_URL +
SPRING_LIQUIBASE_DEFAULT_SCHEMA +
SPRING_LIQUIBASE_USER +
SPRING_LIQUIBASE_PASSWORD +
USED-NON-RECURRING-CONSENT-EXPIRATION.CRON.EXPRESSION +
SPRING_JPA_PROPERTIES_HIBERNATE_DEFAULT_SCHEMA +
skip_ssl_certificate_verification +
JAVA_OPTS
| 38080          
| xs2a-consent-management-db | Postgresql 9.5 | TZ + 
POSTGRESQL_ADMIN_PASSWORD +
POSTGRESQL_DATABASE +
POSTGRESQL_USER +
POSTGRESQL_PASSWORD | 5432
|xs2a-online-banking | NGINX 1.15.5 | TZ + 
XS2A_URL +
LEDGERS_URL +
CMS_URL +
ONLINE_BANKING_SCA_LOGINPAGE +
ONLINE_BANKING_SCA_UIREDIRECT +
MANAGEMENT_ENDPOINTS_WEB_CORS_ALLOWED_METHODS +
MANAGEMENT_ENDPOINTS_WEB_CORS_ALLOWED_ORIGINS + 
JAVA_OPTS
| 8090,8190
|ledgers | Java 8 | TZ + 
SPRING_PROFILES_ACTIVE +
SPRING_JPA_SHOW_SQL +
DB_HOST +
DB_URL +
DB_DATABASE +
DB_USER +
DB_PASSWORD +
LIQUIBASE_ENABLED +
SCA_MULTILEVEL_ENABLED +
SPRING_MAIL_HOST +
SPRING_MAIL_PORT +
SPRING_MAIL_PROPERTIES_MAIL_FROM +
SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH +
SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE 
| 8088,8188
|xs2a-online-banking-ui |NGINX 1.15.5 | TZ + 
ONLINE_BANKING_SERVER_URL +
DEV_PORTAL_URL_EXT +
JAVA_OPTS| 4400
|xs2a-tpp-ui | NGINX 1.15.5 |  TZ +
LEDGERS_URL +
TPP_REST_SERVER_URL +
CERT_GEN_URL 
| 4205
| xs2a-tpp-rest-server |Java 8 |  TZ +
LEDGERS_URL +
SPRING_DATASOURCE_URL +
SPRING_DATASOURCE_USERNAME +
SPRING_DATASOURCE_PASSWORD +
SERVER_KEY +
USED-NON-RECURRING-CONSENT-EXPIRATION.CRON.EXPRESSION +
NOT-CONFIRMED-CONSENT-EXPIRATION.CRON.EXPRESSION +
NOT-CONFIRMED-PAYMENT-EXPIRATION.CRON.EXPRESSION +
CONSENT.CRON.EXPRESSION +
STOPLIST.CRON.EXPRESSION +
ENCRYPTION.CRON.EXPRESSION +
IBAN_GENERATOR_BANKCODE_NISP +
IBAN_GENERATOR_BANKCODE_RANDOM + 
IBAN_GENERATOR_COUNTRYCODE +
JAVA_OPTS | 8093
|developer-portal-ui | NGINX 1.15.5 |  TZ + 
XS2A_URL | 4206
|ledgers-db |  Postgresql 9.5  | TZ +
POSTGRESQL_ADMIN_PASSWORD +
POSTGRESQL_DATABASE +
POSTGRESQL_USER +
POSTGRESQL_PASSWORD 
|  5432
|certificate-generator |Java 8 | TZ + 
JAVA_OPTS| 8092
| smtp server | any mail server to accept and send smtp messages | |
|===



1. Prerequisites

The applications need the following prerequisites.

You need to install it via your linux distrubutions package manager.

Select your linux distribution in the provided manual links.

1.1 PostgreSQL

https://www.digitalocean.com/community/tutorials/how-to-install-and-use-postgresql-on-centos-7

1.2 Java8

https://www.digitalocean.com/community/tutorials/how-to-install-java-on-centos-and-fedora

1.3 NGINX

https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-centos-7

1.4 Mailserver

Additionally we need a working mailserver.
This manual will not cover its installation.

2. Configuration

2.1 PostgreSQL Databases

The application needs two databases. One for consent-management-system and one for ledgers.

Therefore we need to create these databases and two corresponding users.

```sh
$ sudo -u postgres psql
# ledgers-db
$ postgres=# create database ledgers;
$ postgres=# create user ledgersdb with encrypted password 'password-to-change';
$ postgres=# grant all privileges on database ledgers to ledgersdb;

# consent-management-system-db
$ postgres=# CREATE DATABASE cms;
$ postgres=# CREATE USER cmsdb WITH ENCRYPTED PASSWORD 'password-to-change';
$ postgres=# GRANT ALL PRIVILEGES ON DATABASE cms TO cmsdb;
$ postgres=# CREATE SCHEMA consent AUTHORIZATION cmsdb;
```

2.2 Java8 Backends

```sh
# the following line is an example for May:
$ $JAVA_HOME/bin/java --online-banking.sca.uiRedirect=true --online-banking.sca.loginpage=http://localhost:4400/ -jar /opt/profile/aspsp-profile.jar

$JAVA_OPTS_profile
             SPRING.PROFILES.ACTIVE=debug_mode
             BANK.PROFILE.PATH=/data/bank_profile.yml
$JAVA_OPTS_consent
             ASPSP-PROFILE.BASEURL=http://demo-dynamicsandbox-aspspprofile:8080/api/v1
             SPRING.DATASOURCE.URL=jdbc:postgresql://localhost/cms
             SPRING.DATASOURCE.USERNAME=cmsdb
             SPRING.DATASOURCE.PASSWORD=password-to-change
             SERVER.KEY=secret-to-change
             SPRING.LIQUIBASE.ENABLED=true
             SPRING.LIQUIBASE.URL=jdbc:postgresql://localhost/cms?currentSchema=consent
             SPRING.LIQUIBASE.DEFAULT.SCHEMA=consent
             SPRING.LIQUIBASE.USER=cmsdb
             SPRING.LIQUIBASE.PASSWORD=password-to-change
             USED-NON-RECURRING-CONSENT-EXPIRATION.CRON.EXPRESSION="0 0 * * * *"
             SPRING.JPA.PROPERTIES.HIBERNATE.DEFAULT.SCHEMA=consent
             skip.ssl.certificate.verification=true
$JAVA_OPTS_gateway
             SPRING.PROFILES.ACTIVE=postgres,mock-qwac
             ASPSP-PROFILE.BASEURL=http://localhost:8080/api/v1
             CMS.URL=http://localhost:8080
             LEDGERS.URL=http://localhost:8088
             CONSENT.SERVICE.BASEURL=http://localhost:8080/api/v1
             skip.ssl.certificate.verification=true
             DB.PASSWORD=password-to-change
             DB.USER=cmsdb
             DB.DATABASE=cms
             DB.HOST=localhost
$JAVA_OPTS_ledgers
             SPRING.PROFILES.ACTIVE=postgres,sandbox
             DB.HOST=localhost
             DB.DATABASE=ledgers
             DB.USER=ledgersdb
             DB.PASSWORD=password-to-change
             SCA.MULTILEVEL.ENABLED=false
             APPLICATION_SECURITY_ENCRYPTIONALGORITHM=PBEWITHSHA1ANDDESEDE
             APPLICATION_SECURITY_MASTERPASSWORD=secret2-to-change
             ###all possible mail configurations: https://www.quickprogrammingtips.com/spring-boot/how-to-send-email-from-spring-boot-applications.html###
             spring.mail.host=smtp.gmail.com
             spring.mail.port=587
             spring.mail.username=username
             spring.mail.password=password
             spring.mail.properties.mail.smtp.starttls.enable=true
             spring.mail.properties.mail.smtp.starttls.required=true
             spring.mail.properties.mail.smtp.auth=true
             spring.mail.properties.mail.smtp.connectiontimeout=5000
             spring.mail.properties.mail.smtp.timeout=5000
             spring.mail.properties.mail.smtp.writetimeout=5000
$JAVA_OPTS_online
             XS2A.URL=http://localhost:8089
             LEDGERS.URL=http://localhost:8088
             CMS.URL=http://localhost:8080
             ONLINE.BANKING.SCA.LOGINPAGE=https://demo-dynamicsandbox-onlinebankingui.cloud.adorsys.de/
             ONLINE.BANKING.SCA.UIREDIRECT=true
             MANAGEMENT.ENDPOINTS.WEB.CORS.ALLOWED.METHODS=GET,POST,PUT,DELETE,OPTIONS,PATCH
             MANAGEMENT.ENDPOINTS.WEB.CORS.ALLOWED.ORIGINS=https://demo-dynamicsandbox-onlinebankingui.cloud.adorsys.de
$JAVA_OPTS_tpp
             LEDGERS.URL=http://localhost:8088
             SPRING.DATASOURCE.URL=jdbc:postgresql://localhost/cms
             SPRING.DATASOURCE.USERNAME=cmsdb
             SPRING.DATASOURCE.PASSWORD=password-to-change
             SERVER.KEY=secret-to-change
             USED-NON-RECURRING-CONSENT-EXPIRATION.CRON.EXPRESSION="0 0 * * * *"
             NOT-CONFIRMED-CONSENT-EXPIRATION.CRON.EXPRESSION="0 0 * * * *"
             NOT-CONFIRMED-PAYMENT-EXPIRATION.CRON.EXPRESSION="0 0 * * * *"
             CONSENT.CRON.EXPRESSION="0 0 * * * *"
             STOPLIST.CRON.EXPRESSION="0 0 * * * *"
             ENCRYPTION.CRON.EXPRESSION="0 0 * * * *"
             IBAN.GENERATOR.BANKCODE.NISP=76070025
             IBAN.GENERATOR.BANKCODE.RANDOM=90000001
             IBAN.GENERATOR.COUNTRYCODE=AU

# create directory for application binaries
$ mkdir /opt/sandbox
# copy the binaries there
$ cp *.jar /opt/sandbox/
# make the binaries executable
$ chmod +x /opt/sandbox/*.jar
# run the binaries (through a startup script on server boot)
$ $JAVA_HOME/bin/java $JAVA_OPTS_1 -jar /opt/sandbox/aspsp-profile.jar
$ $JAVA_HOME/bin/java $JAVA_OPTS_2 -jar /opt/sandbox/consent-management.jar
$ $JAVA_HOME/bin/java $JAVA_OPTS_3 -jar /opt/sandbox/gateway-app.jar
$ $JAVA_HOME/bin/java $JAVA_OPTS_4 -jar /opt/sandbox/ledgers-app.jar
$ $JAVA_HOME/bin/java $JAVA_OPTS_5 -jar /opt/sandbox/xs2a-online-banking.jar
$ $JAVA_HOME/bin/java $JAVA_OPTS_6 -jar /opt/sandbox/tpp-rest-server.jar
$ $JAVA_HOME/bin/java -jar /opt/sandbox/certificate-generator.jar
```

2.3 Nginx Frontends

```sh
# tpp-ui
cp tpp-ui-nginx.conf /etc/nginx/conf.d/
mkdir /usr/share/nginx/html/tpp-ui/
cp dist/tpp-ui/* /usr/share/nginx/html/tpp-ui/
# developerportal-ui
cp developerportal-ui-nginx.conf /etc/nginx/conf.d/
mkdir /usr/share/nginx/html/developerportal-ui/
cp dist/developerportal-ui/* /usr/share/nginx/html/developerportal-ui/
# onlinebanking-ui
cp onlinebanking-ui-nginx.conf /etc/nginx/conf.d/
mkdir /usr/share/nginx/html/onlinebanking-ui/
cp dist/onlinebanking-ui/* /usr/share/nginx/html/onlinebanking-ui/
```


*1.Prepare and run xs2a-asps-profile:*

* Run java application with correct ENV variables 

```sh
$ $JAVA_HOME/bin/java $JAVA_OPTS -jar /opt/profile/aspsp-profile.jar
```

*2.Prepare and run xs2a-consent-management-db:*

* create database cms
* create schema cms
* create user and password

*3.Prepare and run xs2a-consent-management:*

* Run java application with correct ENV variables, when application will create all data structure in cms database byself

```sh
$ $JAVA_HOME/bin/java $JAVA_OPTS -jar /opt/consents/consent-management.jar
```

*4.Prepare and  run  xs2a-connector-examples:*

* Run java application with correct ENV variables

```sh
$ $JAVA_HOME/bin/java $JAVA_OPTS -jar /opt/gateway-app/gateway-app.jar
```

*5.Prepare and run ledgers-db:*
 
* create database ledgers
* create user and password

*6.Prepare and run ledgers:*

* Run java application with correct ENV variables, when application will create all data structure in ledgers database byself

```sh
$ $JAVA_HOME/bin/java $JAVA_OPTS -jar /opt/ledgers/ledgers-app.jar
```

*7.Prepare and run xs2a-online-banking:*

* Run java application with correct ENV variables

```sh
$ $JAVA_HOME/bin/java $JAVA_OPTS -jar /opt/xs2a-connector-examples/xs2a-online-banking.jar
```

*8.Prepare and run xs2a-online-banking-ui:*

* move files to appropriate webserver directory and open correct ports for web interface

*9.Prepare and run xs2a-tpp-rest-server:*

* Run java application with correct ENV variables


```sh
$ $JAVA_HOME/bin/java $JAVA_OPTS -jar /opt/tpp-app/tpp-rest-server.jar
```

*10.Prepare and run xs2a-tpp-ui:*

* move files to appropriate webserver directory and open correct ports for web interface

*11.Prepare and run developer-portal-ui:*

 * move files to appropriate webserver directory and open correct ports for web interface

*12.Prepare and run certificate-generator:*

* Run java application

```sh
$ $JAVA_HOME/bin/java $JAVA_OPTS -jar /opt/certificate-generator/certificate-generator.jar
```

*13.SMTP server:*

* You can use any mail server which able to accept and send smtp messages from XS2A Sandbox 

*14.Open [Developer Portal](http://localhost:4206) and follow the manual to start working with XS2ASandbox.*


## Links to local Swagger Interfaces

Following urls will access the swagger interfaces:

### XS2A Interface

```
http://localhost:8089/swagger-ui.html
```

### ASPSP-profile

ASPSP-profile is a module where bank-specific settings are stored.

```
http://localhost:48080/swagger-ui.html
```

## Links to local User Interfaces

### Developer portal UI

Developer portal is the main information resource on how to get started, how to test and work with XS2ASandbox.

```
http://localhost:4206
```

### Online banking UI

Online banking UI is an Angular application, developed to provide consents, payment confirmations and cancellation from PSU to ASPSP
 in case of redirect SCA approach.

```
http://localhost:4400
```

### TPP UI

TPP UI is an Angular application, which provides a user interface to TPP and allows to register, get test certificate and 
manage users and accounts.

```
http://localhost:4205
```
